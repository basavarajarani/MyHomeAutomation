
var Boolean NodeMCU2_Switch2_Initial_Run = false
var Boolean NodeMCU2_Switch3_Initial_Run = false

/************************************************************************************************************************
 * Begin of Utility Functions/Procedures
 *************************************************************************************************************************/
 
 
/*
 * Procedure to Turn on the Switch with the run time in Minutes
 */
val org.eclipse.xtext.xbase.lib.Procedures$Procedure2 <SwitchItem, Number> turnOnSwitchWithRunTimerInMinutes = [ 
	SwitchItem switchItem,
	Number timerValueInMinutes |
	logDebug("HomeAutomation","Entering turnOnSwitchWithRunTimerInMinutes with params ["+switchItem.name+","+timerValueInMinutes+"]");
	sendCommand(NodeMCU1_Switch1,ON);
	Thread::sleep(1000)
	sendCommand(switchItem,ON);

	var Timer switchTimer = createTimer(now.plusMinutes(timerValueInMinutes.intValue),[| 
										sendCommand(switchItem,OFF);
										Thread::sleep(1000)
										sendCommand(NodeMCU1_Switch1,OFF);
										])	
										
	logDebug("HomeAutomation","Exiting turnOnSwitchWithRunTimerInMinutes with params ["+switchItem.name+","+timerValueInMinutes+"]");
										
]

/*
 * Procedure to Turn on the Switch with the run time in Seconds
 */
val org.eclipse.xtext.xbase.lib.Procedures$Procedure2 <SwitchItem, Number> turnOnSwitchWithRunTimerInSeconds = [ 
	SwitchItem switchItem,
	Number timerValueInSeconds |
	logDebug("HomeAutomation","Entering turnOnSwitchWithRunTimerInSeconds with params ["+switchItem.name+","+timerValueInSeconds+"]");
	
	sendCommand(NodeMCU1_Switch1,ON);
	Thread::sleep(1000)
	sendCommand(switchItem,ON);

	var Timer switchTimer = createTimer(now.plusSeconds(timerValueInSeconds.intValue),[| 
										sendCommand(switchItem,OFF);
										Thread::sleep(1000)
										sendCommand(NodeMCU1_Switch1,OFF);
										])	
	logDebug("HomeAutomation","Exiting turnOnSwitchWithRunTimerInSeconds with params ["+switchItem.name+","+timerValueInSeconds+"]");
										
]

/*
 * Procedure to configure the Switch1OnTapTimer
 */
val org.eclipse.xtext.xbase.lib.Procedures$Procedure0 calculateSwitch1TimerToday = [ |
	
	var Number Current_Temp = Melbourne_Weather_Current_Temp_In_Celcius.state as DecimalType
	var Number High_Temp = Melbourne_Weather_High_In_Celcius.state as DecimalType
	var Number Low_Temp = Melbourne_Weather_Low_In_Celcius.state as DecimalType
	var Number derivedTemperature =( (Low_Temp+High_Temp)/2 + Current_Temp)/2;	
	var Number derivedTemperatureTimer = Math.ceil((derivedTemperature/10).doubleValue)
	postUpdate(NodeMCU2_Switch1_Timer,derivedTemperatureTimer)
]

/*
 * Procedure to configure the Switch2OnTapTimer
 */
val org.eclipse.xtext.xbase.lib.Procedures$Procedure0 calculateSwitch2TimerToday = [ |
	
	var Number Current_Temp = Melbourne_Weather_Current_Temp_In_Celcius.state as DecimalType
	var Number High_Temp = Melbourne_Weather_High_In_Celcius.state as DecimalType
	var Number Low_Temp = Melbourne_Weather_Low_In_Celcius.state as DecimalType
	var Number derivedTemperature =( (Low_Temp+High_Temp)/2 + Current_Temp)/2;	
	var Number derivedTemperatureTimer = Math.ceil((derivedTemperature/10).doubleValue)
	postUpdate(NodeMCU2_Switch2_Timer,derivedTemperatureTimer)
]

/*
 * Procedure to configure the Switch3OnTapTimer
 */
val org.eclipse.xtext.xbase.lib.Procedures$Procedure0 calculateSwitch3TimerToday = [ |
	
	var Number Current_Temp = Melbourne_Weather_Current_Temp_In_Celcius.state as DecimalType
	var Number High_Temp = Melbourne_Weather_High_In_Celcius.state as DecimalType
	var Number Low_Temp = Melbourne_Weather_Low_In_Celcius.state as DecimalType
	var Number derivedTemperature =( (Low_Temp+High_Temp)/2 + Current_Temp)/2;	
	var Number derivedTemperatureTimer = Math.ceil((derivedTemperature/10).doubleValue)
	
	postUpdate(NodeMCU2_Switch3_Timer,derivedTemperatureTimer)
]

/*
 * Procedure to configure the Switch4OnTapTimer
 */
val org.eclipse.xtext.xbase.lib.Procedures$Procedure0 calculateSwitch4TimerToday = [ |
	
	var Number Current_Temp = Melbourne_Weather_Current_Temp_In_Celcius.state as DecimalType
	var Number High_Temp = Melbourne_Weather_High_In_Celcius.state as DecimalType
	var Number Low_Temp = Melbourne_Weather_Low_In_Celcius.state as DecimalType
	var Number derivedTemperature =( (Low_Temp+High_Temp)/2 + Current_Temp)/2;	
	var Number derivedTemperatureTimer = Math.ceil((derivedTemperature/10).doubleValue)
	
	postUpdate(NodeMCU2_Switch4_Timer,derivedTemperatureTimer)
]

/*
 * Procedure to turn off the switch
 */
 val org.eclipse.xtext.xbase.lib.Procedures$Procedure1 <SwitchItem> turnOffSwitch = [
 	SwitchItem switchItem |
 	switchItem.sendCommand(OFF);
 ]
/************************************************************************************************************************
 * End of Utility Functions/Procedures
 *************************************************************************************************************************/
rule SystemStarted
when
	System started
then
	//calculateSwitch1TimerToday.apply()
	calculateSwitch2TimerToday.apply()
	calculateSwitch3TimerToday.apply()
	calculateSwitch4TimerToday.apply()
end


rule UpdateTapSwitchOnTimings
when
	Time cron "0 0/1 * * * ?"
then
	calculateSwitch1TimerToday.apply()
	calculateSwitch2TimerToday.apply()
	calculateSwitch3TimerToday.apply()
	calculateSwitch4TimerToday.apply()
end


rule SystemStopped
when 
	System shuts down
then
	 	logDebug("HomeAutomation","Entering--> NodeMCU2.SystemStopped")

	/*
	 * Turn off all the switches
	 */
	 
	 NodeMCU2_Switches.members.forEach[ NodeMCU_Switch |
	 	logDebug("HomeAutomation","Switching Off the Switch:"+NodeMCU_Switch.name)
	 	NodeMCU_Switch.sendCommand(OFF)
	 ]
	  
	 	logDebug("HomeAutomation","Exiting--> NodeMCU2.SystemStopped")
	 
end

rule startHangingPotTapFor20SecondsSummer
when
        Time cron "0 30 6,9,12,15,18 * DEC-FEB ?"
then
        turnOnSwitchWithRunTimerInSeconds.apply(NodeMCU2_Switch1,20);
end

rule startHangingPotTapFor20SecondsAutumn
when
        Time cron "0 30 6,13,18 * MAR-MAY,SEP-NOV ?"
then
        turnOnSwitchWithRunTimerInSeconds.apply(NodeMCU2_Switch1,20);
end

rule startHangingPotTapFor20SecondsWinter
when
        Time cron "0 30 6,18 * JUN-AUG ?"
then
        turnOnSwitchWithRunTimerInSeconds.apply(NodeMCU2_Switch1,20);
end

/*
rule testRule
when
	Time cron "0/5 * * * * ?"
then
		var Number rainToday = Melbourne_Weather_Rain_In_MM.state as DecimalType;
		var Number rainYesterday = Melbourne_Weather_Current_Rain_In_MM.historicState(now.minusDays(1)).state as DecimalType;
		
		logDebug("HomeAutomation", "RainToday:"+rainToday+" rainYesterday:"+rainYesterday);
end

*/

rule startFrontLawn4TapFor2Minutes
when
	Time cron "40 6 18 * * ?"
then
		var Number rainToday = Melbourne_Weather_Rain_In_MM.state as DecimalType;
		var Number rainYesterday = Melbourne_Weather_Current_Rain_In_MM.historicState(now.minusDays(1)).state as DecimalType;

	if (rainToday <=5 ) {
		turnOnSwitchWithRunTimerInMinutes.apply(NodeMCU2_Switch2,2);
	}
end

rule startRoseBed2TapFor2MinutesNonSummer
when
	Time cron "0 50 6,18 * * ?"
then
		var Number rainToday = Melbourne_Weather_Rain_In_MM.state as DecimalType;
		var Number rainYesterday = Melbourne_Weather_Current_Rain_In_MM.historicState(now.minusDays(1)).state as DecimalType;

	if (rainToday <=5 ) {
		turnOnSwitchWithRunTimerInMinutes.apply(NodeMCU2_Switch3,2);
		
	}
end

rule startRoseBed2TapFor2MinutesSummer
when
	Time cron "0 50 6,12,18 * DEC-MAR ?"
then
		var Number rainToday = Melbourne_Weather_Rain_In_MM.state as DecimalType;
		var Number rainYesterday = Melbourne_Weather_Current_Rain_In_MM.historicState(now.minusDays(1)).state as DecimalType;

	if (rainToday <=5 ) {
		turnOnSwitchWithRunTimerInMinutes.apply(NodeMCU2_Switch3,2);
		
	}
end
